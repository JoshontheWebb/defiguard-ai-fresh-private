<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeFiGuard AI - Predictive DeFi Compliance Auditor</title>
    <meta name="description" content="Advanced AI-powered smart contract audits for DeFi protocols, outperforming industry standards with real-time insights and 2025 regulatory compliance.">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="/static/styles.css?_=${Date.now()}">
    <style>
        .upgrade-button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        .upgrade-button:hover {
            background-color: #45a049;
        }
        .pricing-table {
            margin-top: 10px;
            border-collapse: collapse;
            width: 100%;
        }
        .pricing-table th, .pricing-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .pricing-table th {
            background-color: #f2f2f2;
        }
        .logout-link {
            color: var(--text-light);
            text-decoration: none;
            padding: clamp(10px, 1.5vw, 12px);
            display: block;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        .logout-link:hover {
            background-color: rgba(52, 73, 94, 0.3);
            color: var(--accent-pink);
            outline: 2px solid var(--focus-outline);
            outline-offset: 2px;
        }
        .logout-container {
            display: none; /* Hidden by default */
        }
        .logged-in .logout-container {
            display: block; /* Shown when logged in */
        }
        .tier-info .loading {
            display: none;
            color: var(--text-light);
            font-style: italic;
        }
        .tier-info.loading .loading {
            display: inline;
        }

        /* PDF Download Button */
        #pdf-download {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 12px;
            display: none;
            transition: background-color 0.3s ease;
        }
        #pdf-download:hover {
            background-color: #c0392b;
        }
        #pdf-download:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            background-color: #34495e;
            border-radius: 8px;
            margin-top: 12px;
            overflow: hidden;
            height: 24px;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.4s ease;
        }
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body {% if session %}class="logged-in"{% endif %}>
    <!-- Hamburger Menu -->
    <div class="hamburger" id="hamburger">
        <div class="bar1"></div>
        <div class="bar2"></div>
        <div class="bar3"></div>
    </div>

    <!-- Header -->
    <header>
        <div class="logo-container">
            <img src="/static/images/defiguard-logo.png" alt="DeFiGuard Logo" class="logo-image">
            {% if session %}
            <p>Welcome, {{ session.userinfo.name or session.userinfo.email }}!</p>
            <a href="/logout" class="logout-link">Logout</a>
            {% else %}
            <a href="/login" class="cta-button">Login</a>
            <a href="/login?screen_hint=signup" class="cta-button">Signup</a>
            {% endif %}
        </div>
    </header>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <ul>
            <li><a href="#home">Home</a></li>
            <li><a href="#audit">Audit Contract</a></li>
            <li><a href="#results">Results Dashboard</a></li>
            <li><a href="#settings">Settings</a></li>
            <li id="auth-status"><a href="/auth">Sign In / Create Account</a></li>
            <li class="logout-container">
                <a href="#" id="logout-sidebar" class="logout-link">Log Out</a>
            </li>
            <li><a href="https://discord.gg/defiguard" target="_blank">Community Support</a></li>
            <li class="priority-support" style="display: none;"><a href="mailto:support@defiguard.ai">Priority Support (Beginner/Pro)</a></li>
        </ul>
        <div class="tier-info" aria-live="polite">
            <span>Tier: Free (Limited audits)</span>
            <span class="loading">Loading tier...</span>
        </div>
        <div class="tier-display"></div> <!-- Added for sidebar tier display -->
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Hero Section -->
        <section id="home" class="hero">
            <h2>Secure Your DeFi Future with AI-Driven Audits</h2>
            <p>Outshine competitors: Analyze Solidity code against MiCA/SEC FIT21 regs, predict risks, and get actionable fixes faster and smarter than CertiK or ConsenSys.</p>
            <a href="#audit" class="cta-button">Start Audit Now</a>
        </section>

        <!-- Progress Tracker -->
        <section id="progress" class="progress-tracker" aria-label="Audit progress steps">
            <h3>Audit Workflow</h3>
            <ol>
                <li>Upload Contract (Solidity File)</li>
                <li>Optional: Add Contract Address</li>
                <li>AI Analysis (Slither + Grok)</li>
                <li>View Report & Recommendations</li>
            </ol>
        </section>

        <!-- Audit Submission Form -->
        <section id="audit" class="audit-section">
            <h2>Submit for Audit</h2>
            <form action="/audit" method="post" enctype="multipart/form-data">
                <label for="file">Upload Solidity File (.sol):</label>
                <input type="file" id="file" name="file" accept=".sol" required aria-describedby="file-help">
                <small id="file-help">Max size: Loading...</small>

                <button id="wallet-connect" type="button">Connect Wallet</button>
                <label for="contract_address" class="pro-diamond-only" style="display: none;">Ethereum Contract Address (Optional):</label>
                <input type="text" id="contract_address" name="contract_address" placeholder="0x..." pattern="^0x[a-fA-F0-9]{40}$" style="display: none;">
                <small>Pro/Diamond tiers only</small>

                <label for="custom_report" class="diamond-only" style="display: none;">Custom Report Instructions (Optional):</label>
                <textarea id="custom_report" name="custom_report" placeholder="E.g., Focus on reentrancy risks..." style="display: none;"></textarea>
                <small>Diamond tier only</small>

                <button type="submit">Audit Contract</button>

                <button type="button" id="diamond-audit" class="diamond-only" style="display: none;">Request Diamond Audit</button>

                <p id="diamond-price" class="diamond-only" style="display: none;">Overage: $0.00</p>
            </form>

            <!-- MOVED .loading INSIDE .audit-section, AFTER form -->
            <div class="loading" aria-live="assertive"></div>

            <div class="usage-warning is-hidden" aria-live="assertive"></div>
<div class="loading" aria-hidden="true">
    <div class="spinner"></div>
    <p>Analyzing contract...</p>
</div>
<div id="pending-message" class="loading" style="display:none;" aria-hidden="true">
    <div class="spinner"></div>
    <p>Audit pending post-upgrade...</p>
</div>
            <div class="upgrade-prompt" aria-live="polite">
                <h3>Subscription Tiers</h3>
                <table class="pricing-table" id="pricing-table">
    <thead>
        <tr>
            <th>Tier</th>
            <th>Price</th>
            <th>Features</th>
        </tr>
    </thead>
    <tbody>
        <!-- Dynamic rows from JS -->
    </tbody>
</table>
                <select id="tier-select" aria-label="Select subscription tier">
                    <option value="beginner">Beginner ($50/mo)</option>
                    <option value="pro">Pro ($200/mo)</option>
                    <option value="diamond">Diamond add-on ($50/mo with Pro + overage)</option>
                </select>
                <button id="tier-switch" class="upgrade-button" aria-label="Upgrade to selected tier">Upgrade Tier</button>
                <a id="upgrade-link" href="/upgrade">Upgrade for more features!</a>
            </div>
            <div class="tier-benefits" aria-live="polite">
                <h3>Tier Benefits</h3>
                <p id="tier-description">Loading tier information...</p>
                <p id="size-limit">Max file size: Loading...</p>
                <p id="features">Features: Loading...</p>
            </div>
            <div id="facet-preview" class="box pro-diamond-only" style="display: none;" aria-hidden="true"></div>
            <div class="results">
                <button id="download-report" class="loading" style="display: none;">Download Report (Beginner/Pro)</button>
                <button id="pdf-download">Download Compliance PDF (Diamond)</button>
                <button id="mint-nft" style="display: none;">Mint NFT Reward (Diamond)</button>
                <button id="x-alerts">Check X Alerts</button>
            </div>
        </section>

        <!-- Results Dashboard -->
        <section id="results" class="results-dashboard" aria-label="Audit results">
            <h3>Audit Results</h3>
            <div class="risk-score-placeholder">
                <p>Risk Score: <span id="risk-score">N/A</span>/100</p>
            </div>

            <div class="issues-table-placeholder">
                <h4>Identified Issues</h4>
                <table role="table" aria-describedby="issues-desc">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Severity</th>
                            <th>Description</th>
                            <th>Fix</th>
                        </tr>
                    </thead>
                    <tbody id="issues-body">
                        <tr><td colspan="4">No issues yet submit an audit to see results.</td></tr>
                    </tbody>
                </table>
                <small id="issues-desc">Vulnerabilities classified by severity (Low/Med/High).</small>
            </div>

            <div class="predictions-placeholder">
                <h4>Risk Predictions</h4>
                <ul id="predictions-list">
                    <li>No predictions yet.</li>
                </ul>
            </div>

            <div class="recommendations-placeholder">
                <h4>Recommendations</h4>
                <ul id="recommendations-list">
                    <li>No recommendations yet.</li>
                </ul>
            </div>

            <div class="fuzzing-placeholder pro-diamond-only" style="display: none;">
                <h4>Fuzzing Results</h4>
                <ul id="fuzzing-list">
                    <li>No fuzzing results yet.</li>
                </ul>
            </div>

            <div class="remediation-placeholder diamond-only" style="display: none;">
                <h4>Remediation Roadmap</h4>
                <p id="remediation-roadmap">No roadmap yet.</p>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings">
            <h3>Account Settings</h3>
            <ul>
                <!-- ID 9: Removed <li>Upgrade Tier: <a href="/upgrade">Beginner ($50/mo), Pro ($200/mo), Diamond add-on ($50/mo with overage)</a></li> -->
                <li>View Usage History</li>
                <li id="api-key" style="display: none;">API Key: <span id="api-key-value">Loading...</span> (Pro only)</li>
            </ul>
        </section>
    </div>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 DeFiGuard AI. Built with FastAPI & Grok.</p>
        <!-- ID 9: Removed <p>Upgrade for unlimited audits: <a href="/upgrade">Details</a></p> -->
    </footer>

    <script src="/static/script.js?_=${Date.now()}"></script>
</body>
</html>